"use strict";angular.module("elasticmaniaApp",["ngAnimate","ngCookies","ngSanitize","ngTouch","firebase","firebase.ref","firebase.auth","ui.router","ui.bootstrap"]).config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/"),a.state("inicio",{url:"/",templateUrl:"views/reserva.html",controller:"ReservaCtrl"}).state("login",{url:"/login",templateUrl:"views/login.html",controller:"LoginCtrl"}).state("cuenta",{url:"/cuenta",templateUrl:"views/account.html",controller:"AccountCtrl",resolve:{currentAuth:["Auth","cacheService",function(a,b){return a.$requireAuth().then(function(a){b.put("authData",a),console.log("cache",b.get("authData"))})}]}}).state("orden",{url:"/orden",templateUrl:"views/orden.html",controller:"OrdenCtrl",resolve:{paquete:["$q","$state","$timeout","cacheService",function(a,b,c,d){var e=a.defer();return c(function(){d.get("orden")?d.get("orden").paquete.length>=1&&e.resolve():"inicio"!==b.current.name&&(b.go("inicio"),e.reject())}),e.promise}]}})}]).run(["$rootScope","Auth","cacheService","$state","$stateParams",function(a,b,c,d,e){a.$state=d,a.$stateParams=e,a.$on("$stateChangeError",function(a,b,c,e,f,g){"AUTH_REQUIRED"===g?d.go("login"):d.go("inicio")})}]),angular.module("elasticmaniaApp").controller("MainCtrl",["$scope","$state",function(a,b){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("firebase.config",[]).constant("FBURL","https://elasticmania.firebaseio.com").constant("SIMPLE_LOGIN_PROVIDERS",["password","facebook","twitter","google"]).constant("loginRedirectPath","/login"),angular.module("firebase.ref",["firebase","firebase.config"]).factory("Ref",["$window","FBURL",function(a,b){return new a.Firebase(b)}]),angular.module("elasticmaniaApp").filter("reverse",function(){return function(a){return angular.isArray(a)?a.slice().reverse():[]}}),function(){angular.module("firebase.auth",["firebase","firebase.ref"]).factory("Auth",["$firebaseAuth","Ref",function(a,b){return a(b)}])}(),angular.module("elasticmaniaApp").controller("LoginCtrl",["$scope","Auth","$state","Ref","$q","$timeout",function(a,b,c,d,e,f){function g(){c.go("cuenta")}function h(b){a.err=b,console.log(b)}a.recuerdame=!1,a.correo="lobo__911@hotmail.com",a.crearCuenta=function(c,i,j,k){function l(a){console.log(a);var b=d.child("users").child(a.uid),g=e.defer();return b.set({email:c,name:c.split("@",2)[0],tel:j},function(a){f(function(){a?(console.log("Perfil fail:",a),g.reject(a)):(console.log("Perfil creado:",b),g.resolve(b))})}),g.promise}console.log("crear cuenta"),a.err=null,i?i!==k?a.err="Passwords do not match":(console.log("se manda el user"),b.$createUser({email:c,password:i}).then(function(){return b.$authWithPassword({email:c,password:i},{rememberMe:!0})}).then(l).then(g,h)):a.err="Please enter a password"},a.oauthLogin=function(c){a.err=null,b.$authWithOAuthPopup(c,{rememberMe:!0}).then(g,h)},a.passwordLogin=function(c,d){a.err=null,b.$authWithPassword({email:c,password:d},{rememberMe:a.recuerdame}).then(g,h)}}]),angular.module("elasticmaniaApp").controller("AccountCtrl",["$scope","cacheService","Auth","$timeout","$state","userFactory",function(a,b,c,d,e,f){a.user=b.get("authData");var g=f.getPerfil(a.user.uid);g.$bindTo(a,"profile"),g.$loaded().then(function(){console.log("exitosamente loaded profile record:",g.$id,g.name)}),f.loadUserEvents(a.user.uid),a.logout=function(){b.remove("authData"),g.$destroy(),e.go("inicio"),c.$unauth()},a.changePassword=function(b,c,d){a.err=null,b&&c?c!==d?console.log("Passwords do not match"):f.changePass(b,c).then(function(a){console.log("Password changed",a)},function(a){console.log(a.code,a.message)}):console.log("Please enter all fields")}}]),angular.module("elasticmaniaApp").directive("ngShowAuth",["Auth","$timeout",function(a,b){return{restrict:"A",link:function(c,d){function e(){b(function(){d.toggleClass("ng-cloak",!a.$getAuth())},0)}d.addClass("ng-cloak"),a.$onAuth(e),e()}}}]),angular.module("elasticmaniaApp").directive("ngHideAuth",["Auth","$timeout",function(a,b){return{restrict:"A",link:function(c,d){function e(){b(function(){d.toggleClass("ng-cloak",!!a.$getAuth())},0)}d.addClass("ng-cloak"),a.$onAuth(e),e()}}}]),angular.module("elasticmaniaApp").factory("cacheService",["$cacheFactory",function(a){var b=a("appcache");return b}]),angular.module("elasticmaniaApp").controller("OrdenCtrl",["$scope","Auth","cacheService","$state","$timeout",function(a,b,c,d,e){a.orden=c.get("orden");var f=new Date;a.today=function(){a.dt=f},a.today(),a.minDate=f,a.mytime=f,a.hstep=1,a.mstep=15,a.ismeridian=!0,a.toggleMode=function(){a.ismeridian=!a.ismeridian},a.update=function(){var b=f;b.setHours(14),b.setMinutes(0),a.mytime=b},a.changed=function(){console.log("Time changed to: "+a.mytime)},a.verificando=!1,a.disponible=null,a.watchCambios=null,a.disponibilidad=function(){a.watchCambios=a.mytime,a.verificando=!0,a.disponible=null,e(function(){a.verificando=!1,a.disponible=!0,console.log("Timestamp elegido:",a.mytime.getTime(),a.mytime)},3e3)},a.enviarReserva=function(){d.go("login")}}]),angular.module("elasticmaniaApp").factory("userFactory",["Ref","$firebaseObject","cacheService","Auth","$firebaseArray",function(a,b,c,d,e){var f=a.child("users"),g=a.child("eventos");return{getPerfil:function(a){return b(f.child(a))},changePass:function(a,b){return d.$changePassword({email:c.get("authData").password.email,oldPassword:a,newPassword:b})},crearEvento:function(a){var b={by:a,tipo:"cumpleaños",ubicacion:"salón cumbres del alma",paquete:[{objeto1:1},{objeto2:2}]},c=e(g);c.$add(b).then(function(a){console.log(a);var b=a.key();console.log("added record with id "+b),c.$indexFor(b)},function(a){console.log("Hubo un error horrible:",a)})},loadUserEvents:function(a){g.orderByChild("by").equalTo(a).on("child_added",function(a){console.log(a,a.key())})}}}]),angular.module("elasticmaniaApp").controller("ReservaCtrl",["$scope","cacheService",function(a,b){var c=a.edadArray=["Entre 2 y 5 años","Entre 5 y 12 años","Entre 12 y 15 años","Más de 15 años"],d=a.invArray=["Aprox. 10","Aprox. 15","Aprox. 20","Aprox. 25","Aprox. 30","Aprox. 35","Aprox. 40"];a.filterValue="juego";var e=[{id:"cam",tipo:"juego",nombre:"Cama elástica",medidas:["2x4x1","4x4x2","1x3x2"],req:{horas:2},precio:{base:700,incremental:200},stock:3,desc:"La diversión de los niños está asegurada durante toda la fiesta con las camas elásticas de elasticmanía!"},{id:"cast",tipo:"juego",nombre:"Castillo inflable",medidas:["2x4x1","4x4x2","1x3x2"],req:{horas:2},precio:{base:500,incremental:200},stock:3,desc:""},{id:"toro",tipo:"juego",nombre:"Toro mecánico",medidas:["2x4x1"],req:{horas:0},precio:{base:2500,incremental:1e3},stock:1,desc:""},{id:"algod",tipo:"comp",nombre:"Algodón de azúcar",medidas:"no",req:{horas:0},precio:{base:1200,acomp:600},stock:2,desc:""},{id:"pop",tipo:"comp",nombre:"Pop corn",medidas:"no",req:{horas:0},precio:{base:1400,acomp:600},stock:2,desc:""},{id:"music",tipo:"comp",nombre:"Música",medidas:"no",req:{horas:0},precio:{base:300,acomp:300,gratis:3},stock:1,desc:""},{id:"pista3x4",tipo:"juego",nombre:"Pista led (3x4)",medidas:["2x4x1"],req:{horas:0},precio:{base:0,variaciones:[{name:"4x4",precio:12e3},{name:"5x4",precio:15e3},{name:"6x4",precio:18e3}]},stock:1,desc:""}];b.put("productos",e),a.productos=b.get("productos");var f={config:{duracion:2,edades:c[0],invitados:d[0],total:0},paquete:[]};b.get("orden")?f=a.orden=b.get("orden"):(b.put("orden",f),a.orden=b.get("orden")),a.$watch("orden",function(a,b){var c=f.config.duracion,d=f.config.total=0;angular.forEach(f.paquete,function(a,b,d){c<a.req.horas?d.splice(b,1):a.precio.incremental?f.paquete[b].costo=(a.precio.base+a.precio.incremental*(c-1))*a.cantidad:a.precio.acomp?f.paquete.length>=2?a.precio.gratis&&f.paquete.length>=a.precio.gratis+1?f.paquete[b].costo=0:f.paquete[b].costo=a.precio.acomp:f.paquete[b].costo=a.precio.base:a.precio.variaciones?f.paquete[b].costo=f.paquete[b].variaciones.precio:f.paquete[b].costo=a.precio.base,f.config.total+=a.costo,console.log("item Nº "+b+": ",a,d)}),console.log("This paquetito for you!",a,b,d)},!0),a.setDuracion=function(b){a.orden.config.duracion=b},a.setEdad=function(b){a.orden.config.edades=c[b]},a.setInvitados=function(b){a.orden.config.invitados=d[b]},a.arreglarMedida=function(a){var b=a.split("x",3),c=b[0],d=b[1],e=b[2];return'<span class="glyphicon glyphicon-resize-horizontal"></span> '+c+"m x "+d+'m <span class="glyphicon glyphicon-resize-vertical"></span> '+e+"m"},a.addProducto=function(a,b,c,d,e,g){f.paquete.push({id:a,nombre:b,req:c,precio:d,costo:0,cantidad:1,stock:e,variaciones:g})},a.editProducto=function(a){angular.forEach(f.paquete,function(b){b.id===a&&b.cantidad!==b.stock&&b.cantidad++})},a.removeProducto=function(a){angular.forEach(f.paquete,function(b,c,d){b.id===a&&(b.cantidad--,b.cantidad<1&&d.splice(c,1))})},a.existeProducto=function(a){var b;return angular.forEach(f.paquete,function(c){c.id===a&&(b=c.cantidad)}),b},a.total=function(){var a;angular.forEach(f.paquete,function(b){return a+=b.precio.costo})}}]);